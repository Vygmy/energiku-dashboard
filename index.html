<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EnergiKu</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #ffffff;
        color: #222;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        padding: 15px;
      }
      h1 {
        color: #0077b6;
        margin-bottom: 20px;
        text-align: center;
      }
      .cards {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-bottom: 25px;
        width: 100%;
        max-width: 1000px;
      }
      .card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 16px;
        width: 200px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        flex: 1 1 200px;
      }
      .card div:first-child {
        font-size: 1rem;
        color: #555;
      }
      .value {
        font-size: 1.6rem;
        margin-top: 8px;
        font-weight: bold;
        color: #d00000;
      }
      #status {
        position: fixed;
        bottom: 10px;
        right: 15px;
        font-size: 0.8rem;
        font-weight: bold;
        color: #444;
        background: rgba(255, 255, 255, 0.8);
        padding: 4px 8px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }
      canvas {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 10px;
        max-width: 95vw;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      /* Responsif */
      @media (max-width: 600px) {
        .card {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <h1>⚡ Dashboard EnergiKu</h1>

    <!-- Data Cards -->
    <div class="cards">
      <div class="card">
        <div>Tegangan (V)</div>
        <div id="voltage" class="value">-</div>
      </div>
      <div class="card">
        <div>Arus (A)</div>
        <div id="current" class="value">-</div>
      </div>
      <div class="card">
        <div>Daya (W)</div>
        <div id="power" class="value">-</div>
      </div>
      <div class="card">
        <div>Energi (kWh)</div>
        <div id="energy" class="value">-</div>
      </div>
      <div class="card">
        <div>Faktor Daya</div>
        <div id="pf" class="value">-</div>
      </div>
      <div class="card">
        <div>Biaya (Rp)</div>
        <div id="cost" class="value">-</div>
      </div>
    </div>

    <!-- Grafik -->
    <canvas id="chart" width="600" height="300"></canvas>

    <!-- Status di pojok kanan bawah -->
    <div id="status">Menghubungkan ke broker...</div>

    <!-- MQTT.js -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Konfigurasi broker EMQX (WebSocket)
      const broker = "wss://broker.emqx.io:8084/mqtt";
      const topicTelemetry = "home/kwhmeter/kwh1/telemetry";
      const topicStatus = "home/kwhmeter/kwh1/status";

      // Client MQTT
      const client = mqtt.connect(broker, {
        clientId: "webclient_" + Math.random().toString(16).substr(2, 8),
      });

      const statusEl = document.getElementById("status");

      // === Chart.js setup ===
      const ctx = document.getElementById("chart").getContext("2d");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [], // waktu
          datasets: [
            {
              label: "Tegangan (V)",
              borderColor: "#0077b6",
              data: [],
              fill: false,
              tension: 0.2,
            },
            {
              label: "Daya (W)",
              borderColor: "#d00000",
              data: [],
              fill: false,
              tension: 0.2,
            },
          ],
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { title: { display: true, text: "Waktu" } },
            y: { title: { display: true, text: "Nilai" } },
          },
        },
      });

      // === MQTT Events ===
      client.on("connect", () => {
        statusEl.innerText = "✅ Terhubung ke Broker EMQX";
        client.subscribe(topicTelemetry);
        client.subscribe(topicStatus);
      });

      client.on("error", (err) => {
        statusEl.innerText = "❌ Gagal terhubung: " + err;
      });

      client.on("close", () => {
        statusEl.innerText = "⚠️ Terputus, mencoba lagi...";
      });

      client.on("message", (t, message) => {
        if (t === topicTelemetry) {
          try {
            const data = JSON.parse(message.toString());
            document.getElementById("voltage").innerText =
              data.voltage.toFixed(2) + " V";
            document.getElementById("current").innerText =
              data.current.toFixed(3) + " A";
            document.getElementById("power").innerText =
              data.power.toFixed(2) + " W";
            document.getElementById("energy").innerText =
              data.energy.toFixed(3) + " kWh";
            document.getElementById("pf").innerText = data.pf.toFixed(2);

            // hitung biaya PLN (tarif Rp 1700/kWh)
            const tarif = 1700;
            const biaya = data.energy * tarif;
            document.getElementById("cost").innerText =
              "Rp " + biaya.toFixed(0);

            // update chart
            const time = new Date().toLocaleTimeString();
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(data.voltage);
            chart.data.datasets[1].data.push(data.power);

            // batasi max 15 data
            if (chart.data.labels.length > 15) {
              chart.data.labels.shift();
              chart.data.datasets.forEach((ds) => ds.data.shift());
            }

            chart.update();
          } catch (e) {
            console.error("JSON tidak valid", e);
          }
        } else if (t === topicStatus) {
          const val = message.toString();
          statusEl.innerText =
            val === "online" ? "🟢 Perangkat Online" : "🔴 Perangkat Offline";
        }
      });
    </script>
  </body>
</html>
